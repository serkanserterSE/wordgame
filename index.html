<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
        integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="index.css" />
    <script src="index.js"></script>

    <script>
        String.prototype.turkishToUpper = function () {
            var string = this;
            var letters = { "i": "İ", "ş": "Ş", "ğ": "Ğ", "ü": "Ü", "ö": "Ö", "ç": "Ç", "ı": "I" };
            string = string.replace(/(([iışğüçö]))/g, function (letter) { return letters[letter]; })
            return string.toUpperCase();
        }
        document.addEventListener('keyup', logKey);
        window.GameSettings = {
            IsGameStarted: false,
            WordsSample: []
        };
        window.Current = {
            WordLength: 0,
            TypingIndex: 0
        }
        $(document).ready(function () {
            setTimeout(() => {
                $(".main").css("display", "block");
                $(".matrix").addClass("displayNone");
                RenderKeyButtons();
            }, 6000);
        });

        function logKey(e) {
            if (window.GameSettings.IsGameStarted) {
                if (e.code === "Backspace" && window.Current.TypingIndex >= 0) {
                    removeCharBox();
                } else if ((e.which <= 90 && e.which >= 48 || [219, 221, 186, 222, 191, 220].includes(e.which))
                    && (window.Current.TypingIndex <= window.Current.WordLength && window.Current.TypingIndex >= 0)) {
                    setCharBox(e.key);
                    window.Current = { WordLength: window.Current.WordLength, TypingIndex: (window.Current.TypingIndex + 1) };
                }
            }
        }

        function StartNewGame() {
            $(".main").css("display", "none");
            $(".game").css("display", "block");

            window.GameSettings.WordsSample = [
                {
                    "Text": "ZÜRAFA ZÜRAFA",
                    "Meaning": "Geviş getiren memelilerden, Afrika'da yaşayan, çok uzun boylu ve boyunlu, derisi benekli, ot yiyen hayvan",
                    "Language": 0,
                    "Length": 13
                },
                {
                    "Text": "ZÜRAFA",
                    "Meaning": "Geviş getiren memelilerden, Afrika'da yaşayan, çok uzun boylu ve boyunlu, derisi benekli, ot yiyen hayvan",
                    "Language": 0,
                    "Length": 6
                },
            ]

            window.GameSettings.IsGameStarted = true;
            GenerateGamePanel(window.GameSettings.WordsSample[0]);
        }

        function GenerateGamePanel(wordSample) {
            if ('content' in document.createElement('template')) {
                var gamePanel = document.querySelector(".game-panel");
                var template = document.querySelector('#gamepanelbox');
                var whitespaceIndexes = findWhiteSpace(wordSample.Text);
                wordSample.Text.replace(' ', '').split("").forEach((element, index) => {
                    var clone = template.content.cloneNode(true);
                    var box = clone.querySelectorAll(".game-panel-char-box");
                    box[0].id = "divchar" + index;
                    var boxSpan = clone.querySelectorAll(".game-panel-char-box>span");
                    boxSpan[0].id = "char" + index;;
                    boxSpan[0].textContent = " ";
                    if (index == 0)
                        boxSpan[0].classList.add('typing');
                    else
                        box[0].classList.add('closed');
                    if (whitespaceIndexes.includes(index)) {
                        box[0].style.marginLeft = "30px";
                    }
                    gamePanel.appendChild(clone);
                });
                window.GameText = {
                    className: "game-text-panel > span",
                    text: wordSample.Meaning,
                    index: 0,
                    typeSpeed: 20
                };
                window.Current = { WordLength: wordSample.Length, TypingIndex: 0 };
                gameTextTypeAnimation()
            } else {
                console.error("template")
            }
        }

        function RenderKeyButtons() {
            if ('content' in document.createElement('template')) {
                var keyPanel1 = document.querySelector("#keys1");
                var template1 = document.querySelector('#keybutton');
                var letters1 = "QWERTYUIOPĞÜ";
                letters1.split('').forEach((key, index) => {
                    var clone = template1.content.cloneNode(true);
                    var box = clone.querySelectorAll(".key-button");
                    box[0].id = "div_" + key;
                    box[0].textContent = key;
                    box[0].addEventListener('click', function (key) { keyButtonClick(key) }.bind(this, key));
                    keyPanel1.appendChild(clone);
                });

                var keyPanel2 = document.querySelector("#keys2");
                var template2 = document.querySelector('#keybutton');
                var letters2 = "ASDFGHJKLŞİ";
                letters2.split('').forEach((key, index) => {
                    var clone = template2.content.cloneNode(true);
                    var box = clone.querySelectorAll(".key-button");
                    box[0].id = "div_" + key;
                    box[0].textContent = key;
                    box[0].addEventListener('click', function (key) { keyButtonClick(key) }.bind(this, key));
                    keyPanel2.appendChild(clone);
                });

                var keyPanel3 = document.querySelector("#keys3");
                var template3 = document.querySelector('#keybutton');
                var letters3 = "ZXCVBNMÖÇ";
                letters3.split('').forEach((key, index) => {
                    var clone = template3.content.cloneNode(true);
                    var box = clone.querySelectorAll(".key-button");
                    box[0].id = "div_" + key;
                    box[0].textContent = key;
                    box[0].addEventListener('click', function (key) { keyButtonClick(key) }.bind(this, key));
                    keyPanel3.appendChild(clone);
                });
            } else {
                console.error("template")
            }
        }

        function setCharBox(char) {
            let index = window.Current.TypingIndex;
            $("#char" + index).html(char.turkishToUpper());
            $("#char" + index).removeClass("typing");
            $("#divchar" + index).removeClass("closed");
            $("#divchar" + index).addClass("opened");
            $("#divchar" + (index + 1)).removeClass("closed");
            $("#char" + (index + 1)).addClass("typing");
        }

        function removeCharBox() {
            let index = window.Current.TypingIndex;
            $("#char" + index).removeClass("typing");
            $("#divchar" + index).addClass("closed");
            $("#divchar" + (index - 1)).removeClass("opened");
            $("#divchar" + (index - 1)).addClass("closed");
            $("#char" + (index - 1)).addClass("typing");
            $("#char" + (index - 1)).html("");

            let ind = (window.Current.TypingIndex - 1) < 0 ? 0 : (window.Current.TypingIndex - 1);
            window.Current = { WordLength: window.Current.WordLength, TypingIndex: ind };
        }

        function keyButtonClick(key) {
            setCharBox(key);
            window.Current = {
                WordLength: window.Current.WordLength, TypingIndex: (window.Current.TypingIndex + 1)
            }
        }

        function gameTextTypeAnimation() {
            if (window.GameText.index < window.GameText.text.length) {
                let txt = $("." + window.GameText.className).html() + window.GameText.text.charAt(window.GameText.index)
                $("." + window.GameText.className).html(txt);
                window.GameText.index++;
                setTimeout(gameTextTypeAnimation, window.GameText.typeSpeed);
            }
        }

        function findWhiteSpace(text) {
            var indexes = [];
            text.split("").forEach((element, index) => {
                if (element === " ") {
                    indexes.push(index);
                }
            });
            return indexes;
        }

    </script>
</head>

<body>
    <div class="matrix">
        <canvas></canvas>
    </div>
    <div class="main">
        <div class="main-panel">
            <div class="typing-container">
                <div class="typed-out">
                    Lorem ipsum dolor sit amet
                </div>
            </div>
            <div>
                <div class="typing-container">
                    <div class="typed-out">
                        <button type="button" class="main-panel-button" onclick="StartNewGame()">New Game</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="game">
        <div class="game-text-panel"><span></span></div>
        <div class="game-panel"></div>
        <div>
            <div style="display: flex;flex-wrap: nowrap;justify-content: space-between;margin-left: 10%;margin-right: 10%;">
                <div class="key-button" onclick="removeCharBox()">Sil</div>
                <div class="key-button" onclick="">OK</div>
            </div>
            <div>
                <div class="keys" id="keys1"></div>
                <div class="keys" id="keys2"></div>
                <div class="keys" id="keys3"></div>
            </div>
        </div>
    </div>
    <template id="gamepanelbox">
        <div class="game-panel-char-box"><span></span></div>
    </template>
    <template id="keybutton">
        <div class="key-button"></div>
    </template>
    <script type="text/javascript" src="matrix/matrix.js"></script>
    <link rel="stylesheet" href="matrix/matrix.css" />
</body>

</html>